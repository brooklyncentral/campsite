# Copyright 2014 by Cloudsoft Corporation Limited

id: campsite
name: "Campsite Application"
origin: "http://github.com/borooklyncentral/campsite/"
locations:
- my-docker-cloud
services:
- serviceType: brooklyn.entity.database.MySqlNode
  id: mysql
  name: "Database"
  brooklyn.config:
    creationScriptUrl: classpath://brooklyn/campsite/create-campsite-user.sql
- serviceType: brooklyn.entity.messaging.RabbitBroker
  id: rabbit
  name: "Queue"
- serviceType: brooklyn.entity.webapp.ControlledDynamicWebAppCluster
  id: campsite-cluster
  name: "Campsite Cluster"
  brooklyn.config:
    initialSize: 1
    proxy.http.port: "8000+"
    memberSpec:
      $brooklyn:entitySpec:
        type: brooklyn.campsite.CampsiteWebapp
        name: "Campsite"
        brooklyn.config:
          provisioningProperties:
            os64bit: true
            minRam: 7000
          httpPort: "8080+"
          objectStorage: AWSObjectStorage
          queueService: RabbitMQ
          s3AccessKey: XXXX
          s3SecretKey: XXXXXXXX
          s3BucketName: "campsite-public"
          sPrivateBucketName: "campsite-public"
          databaseHost: component("mysql").attributeWhenReady("host.name")
          databasePort: component("mysql").attributeWhenReady("mapped.mysql.port")
          databaseUser: "campsite"
          databasePassword: "p4ssw0rd"
          rabbitHost: component("rabbit").attributeWhenReady("host.name")
          rabbitPort: component("rabbit").attributeWhenReady("mapped.amqp.port")
    controlleddynamicwebappcluster.webClusterSpec:
      $brooklyn:entitySpec:
        type: brooklyn.entity.webapp.DynamicWebAppCluster
        brooklyn.config:
          dynamiccluster.zone.enable: true
          dynamiccluster.zone.placementStrategy:
            brooklyn.location.docker.strategy.BreadthFirstPlacementStrategy
    controlleddynamicwebappcluster.controllerSpec:
      $brooklyn:entitySpec:
        type: brooklyn.entity.proxy.nginx.NginxController
        brooklyn.config:
          member.sensor.hostandport: "mapped.http.port"
- serviceType: brooklyn.campsite.CampsiteApi
  id: api
  name: "API"
  brooklyn.config:
    databaseHost: component("mysql").attributeWhenReady("host.name")
    databasePort: component("mysql").attributeWhenReady("mapped.mysql.port")
    databaseUser: "campsite"
    databasePassword: "p4ssw0rd"
